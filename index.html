<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NeoGoat Deck Builder</title>

<style>
body { margin:0; background:#0b0b0b; color:#f2f2f2; font-family:system-ui,sans-serif; }
header { padding:14px; border-bottom:1px solid #222; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
input, select, button { font:inherit; }
input { padding:8px 10px; border-radius:8px; border:1px solid #333; background:#111; color:white; }
select { padding:7px 8px; border-radius:8px; border:1px solid #333; background:#111; color:white; }
button { padding:7px 10px; border-radius:8px; border:1px solid #333; background:#151515; color:white; cursor:pointer; }
button:hover { background:#1a1a1a; }
main { display:grid; grid-template-columns: 1fr 420px; gap:14px; padding:14px; }
.card { border:1px solid #222; background:#101010; padding:12px; border-radius:12px; }
.list { display:flex; flex-direction:column; gap:8px; max-height:70vh; overflow:auto; }
.row { display:flex; justify-content:space-between; gap:10px; }
.name { font-weight:700; }
.small { font-size:12px; opacity:.8; }
.tab { padding:5px 10px; border:1px solid #333; border-radius:999px; cursor:pointer; font-size:12px; }
.tab.active { background:#1b1b1b; }
.tabs { display:flex; gap:8px; margin:10px 0; }
.err { color:#ff8080; font-size:12px; }
.ok { color:#8fff8f; font-size:12px; }
</style>
</head>

<body>

<header>
<h2>NeoGoat Deck Builder</h2>
<div id="status">Loading...</div>
<div style="flex:1"></div>
<input id="search" placeholder="Search card name...">
<button id="saveBtn">Save</button>
<button id="loadBtn">Load</button>
<button id="clearBtn">New</button>
<button id="exportBtn">Export</button>
</header>

<main>

<section class="card">
<h3>Results</h3>
<div class="list" id="results"></div>
</section>

<aside class="card">
<h3>Deck</h3>

<div class="tabs">
<div class="tab active" data-tab="main">Main (<span id="mainCount">0</span>)</div>
<div class="tab" data-tab="extra">Extra (<span id="extraCount">0</span>)</div>
<div class="tab" data-tab="side">Side (<span id="sideCount">0</span>)</div>
</div>

<div class="list" id="deckList"></div>
<div id="validation" class="small"></div>
</aside>

</main>

<script>
(async function(){

const LS_KEY = "neogoat_local_v1";

let cards = {};
let rules = {};
let legalIds = [];
let currentTab = "main";

let deck = {
  main: new Map(),
  extra: new Map(),
  side: new Map()
};

function count(section){
  let t=0;
  for (let v of deck[section].values()) t+=v;
  return t;
}

function totalCopies(id){
  return (deck.main.get(id)||0)+(deck.extra.get(id)||0)+(deck.side.get(id)||0);
}

function renderDeck(){
  const list = document.getElementById("deckList");
  list.innerHTML="";
  const section = deck[currentTab];

  for (let [id,qty] of section){
    const c = cards[id];
    const div = document.createElement("div");
    div.className="row";
    div.innerHTML = `
      <div>
        <div class="name">${qty}x ${c.name}</div>
        <div class="small">Limit: ${rules[id]?.limit ?? "-"}</div>
      </div>
      <div>
        <button onclick="addCard('${id}')">+</button>
        <button onclick="removeCard('${id}')">-</button>
      </div>
    `;
    list.appendChild(div);
  }

  document.getElementById("mainCount").textContent=count("main");
  document.getElementById("extraCount").textContent=count("extra");
  document.getElementById("sideCount").textContent=count("side");

  validateDeck();
}

function validateDeck(){
  let errors=[];
  let mainCount=count("main");
  let extraCount=count("extra");
  let sideCount=count("side");

  if(mainCount<40||mainCount>60) errors.push("Main must be 40-60");
  if(extraCount>15) errors.push("Extra max 15");
  if(sideCount>15) errors.push("Side max 15");

  for(let id of legalIds){
    let limit=rules[id]?.limit;
    if(limit!=null && totalCopies(id)>limit)
      errors.push(cards[id].name+" exceeds limit");
  }

  const val=document.getElementById("validation");
  if(errors.length){
    val.innerHTML=errors.join("<br>");
    val.className="err";
  }else{
    val.textContent="Deck OK";
    val.className="ok";
  }
}

window.addCard=function(id){
  if(!rules[id]?.legal) return;
  let limit=rules[id]?.limit;
  if(limit!=null && totalCopies(id)>=limit) return;
  let section=deck[currentTab];
  section.set(id,(section.get(id)||0)+1);
  renderDeck();
}

window.removeCard=function(id){
  let section=deck[currentTab];
  let q=section.get(id)||0;
  if(q<=1) section.delete(id);
  else section.set(id,q-1);
  renderDeck();
}

function renderResults(query){
  const list=document.getElementById("results");
  list.innerHTML="";
  query=query.toLowerCase();

  for(let id of legalIds){
    const c=cards[id];
    if(!c.name.toLowerCase().includes(query)) continue;

    const div=document.createElement("div");
    div.className="row";
    div.innerHTML=`
      <div>
        <div class="name">${c.name}</div>
        <div class="small">${c.type||""} ${c.attribute||""}</div>
      </div>
      <button onclick="addCard('${id}')">Add</button>
    `;
    list.appendChild(div);
  }
}

document.getElementById("search").addEventListener("input",e=>{
  renderResults(e.target.value);
});

document.querySelectorAll(".tab").forEach(tab=>{
  tab.addEventListener("click",()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    currentTab=tab.dataset.tab;
    renderDeck();
  });
});

document.getElementById("saveBtn").onclick=()=>{
  localStorage.setItem(LS_KEY,JSON.stringify({
    main:[...deck.main],
    extra:[...deck.extra],
    side:[...deck.side]
  }));
  alert("Saved locally");
};

document.getElementById("loadBtn").onclick=()=>{
  const raw=localStorage.getItem(LS_KEY);
  if(!raw) return alert("No saved deck");
  const obj=JSON.parse(raw);
  deck.main=new Map(obj.main);
  deck.extra=new Map(obj.extra);
  deck.side=new Map(obj.side);
  renderDeck();
};

document.getElementById("clearBtn").onclick=()=>{
  deck.main.clear();
  deck.extra.clear();
  deck.side.clear();
  renderDeck();
};

document.getElementById("exportBtn").onclick=()=>{
  let text="# Main\n";
  for(let [id,q] of deck.main) text+=q+" "+cards[id].name+"\n";
  text+="\n# Extra\n";
  for(let [id,q] of deck.extra) text+=q+" "+cards[id].name+"\n";
  text+="\n# Side\n";
  for(let [id,q] of deck.side) text+=q+" "+cards[id].name+"\n";
  navigator.clipboard.writeText(text);
  alert("Copied to clipboard");
};

try{
  const cfg=await (await fetch('/data/config.json')).json();
  cards=await (await fetch('/data/cards_catalog.json')).json();
  rules=await (await fetch(`/data/formats/${cfg.currentFormatId}/rules.json`)).json();

  legalIds=Object.keys(rules).filter(id=>rules[id]?.legal===true);

  document.getElementById("status").textContent="Ready âœ”";
  renderResults("");
  renderDeck();
}catch(e){
  console.error(e);
  document.getElementById("status").textContent="Failed loading JSON";
}

})();
</script>

</body>
</html>
